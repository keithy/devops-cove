#!/usr/bin/env ruby
# frozen_string_literal: true
require 'yaml'
root = File.expand_path(File.join(__dir__, '..', '..'))
dir  = File.join(root, 'the-github-taverns', 'the-coopers-inn', 'linux')
Dir.chdir(dir)
canon = Dir.glob('builder-*.hm.yml').sort.first
puts "Canonical: #{canon}"
# Get step names from canonical
canon_steps = YAML.load_file(canon).dig('jobs','build','steps') || []
step_names = canon_steps.map { |s| s['name'] }.compact
# Function to extract a step block as a Ruby hash by name
load_steps = ->(path) { (YAML.load_file(path).dig('jobs','build','steps') || []).map { |s| [s['name'], s] }.to_h }
canon_map = load_steps.call(canon)
status = 0
Dir.glob('builder-*.hm.yml').sort.each do |f|
  ok = true
  other_map = load_steps.call(f)
  step_names.each do |name|
    c = canon_map[name]
    o = other_map[name]
    next unless c && o
    c_norm = Marshal.load(Marshal.dump(c)); c_norm.delete('id')
    o_norm = Marshal.load(Marshal.dump(o)); o_norm.delete('id')
    unless c_norm == o_norm
      puts "[FAIL] #{f}: step differs: #{name}"
      ok = false
    end
  end
  y = YAML.load_file(f)
  ok ? (puts "[OK]   #{f}") : status = 1
end
exit status
